{"componentChunkName":"component-mdx.js","path":"/client-certificates/configure-your-mobile-app-or-iot-device","result":{"data":{"mdx":{"id":"5723ab69-1dc0-50b8-b36d-ada4a59cc8da","body":"<h1 id="configure-your-mobile-app-or-iot-device">Configure your mobile app or IoT device</h1><p>To configure your Internet-of-things (IoT) device and mobile application to use client certificates with <a href="https://developers.cloudflare.com/firewall/cf-firewall-rules/api-shield" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">API Shield™</span><span class="DocsMarkdown--link-external-icon" aria-hidden="true"><svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 16 16" role="img" aria-labelledby="title-33787069651214774" xmlns="http://www.w3.org/2000/svg"><title id="title-33787069651214774">External link icon</title><path d="M6.75,1.75h-5v12.5h12.5v-5m0,-4v-3.5h-3.5M8,8l5.5-5.5"></path></svg><span is-visually-hidden="">Open external link</span></span></a>, follow this workflow:</p><ul><li><a href="#create-cloudflare-issued-certificates" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">Create Cloudflare-issued certificates</span></a>.</li><li><a href="#embed-the-client-certificate-in-your-mobile-app" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">Embed the certificate in your mobile app</span></a>.</li><li><a href="#embed-the-client-certificate-on-your-iot-device" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">Embed the certificate on your IoT device</span></a>.</li><li><a href="#enable-mtls" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">Enable mutual Transport Layer Security (mTLS)</span></a>.</li><li><a href="#configure-api-shield-to-require-client-certificates" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">Configure API Shield</span></a> to require the use of Cloudflare-issued certificates.</li></ul><p>This walkthrough uses the example of a device that captures temperature readings and transmits them by sending a POST request to a Cloudflare-protected API. A mobile application built in Swift for iOS retrieves those readings and displays them.</p><p>To keep this example simple, the API is implemented as a Cloudflare Worker (borrowing code from the <a href="https://developers.cloudflare.com/workers/tutorials/build-a-jamstack-app" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">To-Do List tutorial on building a jamstack app</span><span class="DocsMarkdown--link-external-icon" aria-hidden="true"><svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 16 16" role="img" aria-labelledby="title-8654511428493087" xmlns="http://www.w3.org/2000/svg"><title id="title-8654511428493087">External link icon</title><path d="M6.75,1.75h-5v12.5h12.5v-5m0,-4v-3.5h-3.5M8,8l5.5-5.5"></path></svg><span is-visually-hidden="">Open external link</span></span></a>).</p><p>Temperatures are stored in <a href="https://developers.cloudflare.com/workers/learning/how-kv-works" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">Workers KV</span><span class="DocsMarkdown--link-external-icon" aria-hidden="true"><svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 16 16" role="img" aria-labelledby="title-44373085254674693" xmlns="http://www.w3.org/2000/svg"><title id="title-44373085254674693">External link icon</title><path d="M6.75,1.75h-5v12.5h12.5v-5m0,-4v-3.5h-3.5M8,8l5.5-5.5"></path></svg><span is-visually-hidden="">Open external link</span></span></a> using the source IP address as a key, but you can easily use a <a href="https://developers.cloudflare.com/access/service-auth/mtls-headers/" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">value from the client certificate</span><span class="DocsMarkdown--link-external-icon" aria-hidden="true"><svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 16 16" role="img" aria-labelledby="title-27908890128438923" xmlns="http://www.w3.org/2000/svg"><title id="title-27908890128438923">External link icon</title><path d="M6.75,1.75h-5v12.5h12.5v-5m0,-4v-3.5h-3.5M8,8l5.5-5.5"></path></svg><span is-visually-hidden="">Open external link</span></span></a>, such as the fingerprint.</p><p>The example API code below saves a temperature and timestamp into KV when a POST is made, and returns the most recent 5 temperatures when a GET request is made.</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-js" language="js"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> defaultData </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"> temperatures</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function-variable CodeBlock--token-function">getCache</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-parameter">key</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-arrow CodeBlock--token-operator">=&gt;</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-constant">TEMPERATURES</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">get</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">key</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function-variable CodeBlock--token-function">setCache</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-parameter">key</span><span class="CodeBlock--token-parameter CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-parameter"> data</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-arrow CodeBlock--token-operator">=&gt;</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-constant">TEMPERATURES</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">put</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">key</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> data</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-declaration-keyword">async</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-declaration-keyword">function</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">addTemperature</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-parameter">request</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment">// Pull previously recorded temperatures for this client.</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> ip </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> request</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">headers</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">get</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'CF-Connecting-IP'</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> cacheKey </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-template-string CodeBlock--token-template-punctuation CodeBlock--token-string">`</span><span class="CodeBlock--token-template-string CodeBlock--token-string">data-</span><span class="CodeBlock--token-template-string CodeBlock--token-interpolation CodeBlock--token-interpolation-punctuation CodeBlock--token-punctuation">${</span><span class="CodeBlock--token-template-string CodeBlock--token-interpolation">ip</span><span class="CodeBlock--token-template-string CodeBlock--token-interpolation CodeBlock--token-interpolation-punctuation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-template-string CodeBlock--token-template-punctuation CodeBlock--token-string">`</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-declaration-keyword">let</span><span class="CodeBlock--token-plain"> data</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> cache </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-declaration-keyword">await</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">getCache</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">cacheKey</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-operator">!</span><span class="CodeBlock--token-plain">cache</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-declaration-keyword">await</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">setCache</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">cacheKey</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">JSON</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">stringify</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">defaultData</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        data </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> defaultData</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">else</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        data </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">JSON</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">parse</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">cache</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment">// Append the recorded temperatures with the submitted reading (assuming it has both temperature and a timestamp).</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">try</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> body </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-declaration-keyword">await</span><span class="CodeBlock--token-plain"> request</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">text</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> val </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">JSON</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">parse</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">body</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">val</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">temperature</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">&amp;&amp;</span><span class="CodeBlock--token-plain"> val</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">time</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">            data</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">temperatures</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">push</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">val</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">            </span><span class="CodeBlock--token-declaration-keyword">await</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">setCache</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">cacheKey</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">JSON</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">stringify</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">data</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">            </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-api">Response</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">""</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"> status</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">201</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">else</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">            </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-api">Response</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"Unable to parse temperature and/or timestamp from JSON POST body"</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"> status</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">400</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">catch</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">err</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-api">Response</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">err</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"> status</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">500</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-declaration-keyword">function</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">compareTimestamps</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-parameter">a</span><span class="CodeBlock--token-parameter CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-parameter">b</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">-</span><span class="CodeBlock--token-number">1</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">*</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">Date</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">parse</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">a</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">time</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">-</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">Date</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">parse</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">b</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">time</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-comment">// Return the 5 most recent temperature measurements.</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-declaration-keyword">async</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-declaration-keyword">function</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">getTemperatures</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-parameter">request</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> ip </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> request</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">headers</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">get</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'CF-Connecting-IP'</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> cacheKey </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-template-string CodeBlock--token-template-punctuation CodeBlock--token-string">`</span><span class="CodeBlock--token-template-string CodeBlock--token-string">data-</span><span class="CodeBlock--token-template-string CodeBlock--token-interpolation CodeBlock--token-interpolation-punctuation CodeBlock--token-punctuation">${</span><span class="CodeBlock--token-template-string CodeBlock--token-interpolation">ip</span><span class="CodeBlock--token-template-string CodeBlock--token-interpolation CodeBlock--token-interpolation-punctuation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-template-string CodeBlock--token-template-punctuation CodeBlock--token-string">`</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> cache </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-declaration-keyword">await</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">getCache</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">cacheKey</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-operator">!</span><span class="CodeBlock--token-plain">cache</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-api">Response</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">JSON</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">stringify</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">defaultData</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"> status</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">200</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> headers</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'content-type'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'application/json'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">else</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        data </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">JSON</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">parse</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">cache</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-declaration-keyword">const</span><span class="CodeBlock--token-plain"> retval </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-known-class-name CodeBlock--token-class-name">JSON</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">stringify</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">data</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">temperatures</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">sort</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">compareTimestamps</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">splice</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-number">0</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-number">5</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-api">Response</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">retval</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"> status</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">200</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> headers</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'content-type'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'application/json'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-declaration-keyword">async</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-declaration-keyword">function</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">handleRequest</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-parameter">request</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">request</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">method</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">===</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'POST'</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">addTemperature</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">request</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">else</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">getTemperatures</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">request</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-builtin">addEventListener</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'fetch'</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-parameter">event</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-arrow CodeBlock--token-operator">=&gt;</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  event</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-method CodeBlock--token-function CodeBlock--token-property-access">respondWith</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-function">handleRequest</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">event</span><span class="CodeBlock--token-operator">.</span><span class="CodeBlock--token-property-access">request</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">)</span></span></span></span></span></code></pre><hr><h2 id="validate-api"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#validate-api" aria-hidden="true">​</a></span><span>Validate API</span></h2><h3 id="post-sample-data-to-api"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#post-sample-data-to-api" aria-hidden="true">​</a></span><span>POST sample data to API</span></h3><p>To validate the API before adding mTLS authentication, POST a random temperature reading:</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-bash" language="bash"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-assign-left CodeBlock--token-variable">TEMPERATURE</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-variable">$(</span><span class="CodeBlock--token-variable CodeBlock--token-builtin CodeBlock--token-class-name">echo</span><span class="CodeBlock--token-variable"> </span><span class="CodeBlock--token-variable CodeBlock--token-punctuation">$((</span><span class="CodeBlock--token-variable CodeBlock--token-number">361</span><span class="CodeBlock--token-variable"> + </span><span class="CodeBlock--token-variable CodeBlock--token-environment CodeBlock--token-constant">RANDOM</span><span class="CodeBlock--token-variable"> %11</span><span class="CodeBlock--token-variable CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-variable">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">awk</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'{printf("%.2f",</span><span class="CodeBlock--token-string CodeBlock--token-variable">$1</span><span class="CodeBlock--token-string">/10.0)}'</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-assign-left CodeBlock--token-variable">TIMESTAMP</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-variable">$(</span><span class="CodeBlock--token-variable CodeBlock--token-function">date</span><span class="CodeBlock--token-variable"> -u +</span><span class="CodeBlock--token-variable CodeBlock--token-string">"%Y-%m-%dT%H:%M:%SZ"</span><span class="CodeBlock--token-variable">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">echo</span><span class="CodeBlock--token-plain"> -e </span><span class="CodeBlock--token-string">"</span><span class="CodeBlock--token-string CodeBlock--token-variable">$TEMPERATURE</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string CodeBlock--token-variable">$TIMESTAMP</span><span class="CodeBlock--token-string">"</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-number">36.70</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-number">2020</span><span class="CodeBlock--token-plain">-09-28T02:54:56Z</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">curl</span><span class="CodeBlock--token-plain"> -v -H </span><span class="CodeBlock--token-string">"Content-Type: application/json"</span><span class="CodeBlock--token-plain"> -d </span><span class="CodeBlock--token-string">'{"temperature":'</span><span class="CodeBlock--token-string">''</span><span class="CodeBlock--token-variable">$TEMPERATURE</span><span class="CodeBlock--token-string">''</span><span class="CodeBlock--token-string">', "time": "'</span><span class="CodeBlock--token-string">''</span><span class="CodeBlock--token-variable">$TIMESTAMP</span><span class="CodeBlock--token-string">''</span><span class="CodeBlock--token-string">'"}'</span><span class="CodeBlock--token-plain"> https://shield.upinatoms.com/temps </span><span class="CodeBlock--token-operator CodeBlock--token-file-descriptor CodeBlock--token-important">2</span><span class="CodeBlock--token-operator">&gt;</span><span class="CodeBlock--token-file-descriptor CodeBlock--token-important">&amp;1</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">grep</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"&lt; HTTP/2"</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-operator">&lt;</span><span class="CodeBlock--token-plain"> HTTP/2 </span><span class="CodeBlock--token-number">201</span></span></span></span></span></code></pre><h3 id="get-sample-data-from-api"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#get-sample-data-from-api" aria-hidden="true">​</a></span><span>GET sample data from API</span></h3><p>A GET request to the <code class="InlineCode">temps</code> endpoint returns the most recent readings, including the one submitted in the example above:</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-json" language="json"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ curl -s https</span><span class="CodeBlock--token-operator">:</span><span class="CodeBlock--token-comment">//shield.upinatoms.com/temps | jq .</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-property">"temperature"</span><span class="CodeBlock--token-operator">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">36.3</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-property">"time"</span><span class="CodeBlock--token-operator">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"2020-09-28T02:57:49Z"</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-property">"temperature"</span><span class="CodeBlock--token-operator">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">36.7</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-property">"time"</span><span class="CodeBlock--token-operator">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"2020-09-28T02:54:56Z"</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-property">"temperature"</span><span class="CodeBlock--token-operator">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">36.2</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-property">"time"</span><span class="CodeBlock--token-operator">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"2020-09-28T02:33:08Z"</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">]</span></span></span></span></span></code></pre><hr><h2 id="create-cloudflare-issued-certificates"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#create-cloudflare-issued-certificates" aria-hidden="true">​</a></span><span>Create Cloudflare-issued certificates</span></h2><p>Before you can use API Shield to protect your API or web application, you must create Cloudflare-issued client certificates.</p><p>You can <a class="DocsMarkdown--link" href="/ssl/client-certificates/create-a-client-certificate"><span class="DocsMarkdown--link-content">create a client certificate in the Cloudflare dashboard</span></a>.</p><p>However, since most developers working at scale generate their own private keys and certificate signing requests via API, this example uses the Cloudflare API to create client certificates.</p><aside class="DocsMarkdown--aside" role="note" data-type="warning"><div class="DocsMarkdown--aside-header">Important</div><p>You can only use API Shield with a certificate authority (CA) that is fully managed by Cloudflare. Cloudflare generates a unique CA for each zone.</p><p>If you need to use a different CA, contact a Cloudflare customer success manager.</p></aside><p>To create a bootstrap certificate for the iOS application and the IoT device, this example uses <a href="https://github.com/cloudflare/cfssl" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">Cloudflare’s public key infrastructure toolkit, CFSSL</span><span class="DocsMarkdown--link-external-icon" aria-hidden="true"><svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 16 16" role="img" aria-labelledby="title-1432481318383747" xmlns="http://www.w3.org/2000/svg"><title id="title-1432481318383747">External link icon</title><path d="M6.75,1.75h-5v12.5h12.5v-5m0,-4v-3.5h-3.5M8,8l5.5-5.5"></path></svg><span is-visually-hidden="">Open external link</span></span></a>:</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-bash" language="bash"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># Generate a private key and CSR for the iOS device.</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">cat</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">&lt;&lt;</span><span class="CodeBlock--token-string">'EOF'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">tee</span><span class="CodeBlock--token-plain"> -a csr.json</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"hosts"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">"ios-bootstrap.devices.upinatoms.com"</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"CN"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"ios-bootstrap.devices.upinatoms.com"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"key"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">"algo"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"rsa"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">"size"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">2048</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"names"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">"C"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"US"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">"L"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Austin"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">"O"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Temperature Testers, Inc."</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">"OU"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Tech Operations"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">"ST"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Texas"</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">EOF</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ cfssl genkey csr.json </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> cfssljson -bare certificate</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-number">2020</span><span class="CodeBlock--token-plain">/09/27 </span><span class="CodeBlock--token-number">21</span><span class="CodeBlock--token-plain">:28:46 </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain">INFO</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> generate received request</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-number">2020</span><span class="CodeBlock--token-plain">/09/27 </span><span class="CodeBlock--token-number">21</span><span class="CodeBlock--token-plain">:28:46 </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain">INFO</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> received CSR</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-number">2020</span><span class="CodeBlock--token-plain">/09/27 </span><span class="CodeBlock--token-number">21</span><span class="CodeBlock--token-plain">:28:46 </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain">INFO</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> generating key: rsa-2048</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-number">2020</span><span class="CodeBlock--token-plain">/09/27 </span><span class="CodeBlock--token-number">21</span><span class="CodeBlock--token-plain">:28:47 </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain">INFO</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> encoded CSR</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">mv</span><span class="CodeBlock--token-plain"> certificate-key.pem ios-key.pem</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">mv</span><span class="CodeBlock--token-plain"> certificate.csr ios.csr</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-comment"># Do the same for the IoT sensor.</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">sed</span><span class="CodeBlock--token-plain"> -i.bak </span><span class="CodeBlock--token-string">'s/ios-bootstrap/sensor-001/g'</span><span class="CodeBlock--token-plain"> csr.json</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ cfssl genkey csr.json </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> cfssljson -bare certificate</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">..</span><span class="CodeBlock--token-plain">.</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">mv</span><span class="CodeBlock--token-plain"> certificate-key.pem sensor-key.pem</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">mv</span><span class="CodeBlock--token-plain"> certificate.csr sensor.csr</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">// now ask that these CSRs be signed by the private CA issued </span><span class="CodeBlock--token-keyword">for</span><span class="CodeBlock--token-plain"> your zone</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">// we need to replace actual newlines </span><span class="CodeBlock--token-keyword">in</span><span class="CodeBlock--token-plain"> the CSR with ‘</span><span class="CodeBlock--token-punctuation">\</span><span class="CodeBlock--token-plain">n’ before POST’ing</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-assign-left CodeBlock--token-variable">CSR</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-variable">$(</span><span class="CodeBlock--token-variable CodeBlock--token-function">cat</span><span class="CodeBlock--token-variable"> ios.csr </span><span class="CodeBlock--token-variable CodeBlock--token-operator">|</span><span class="CodeBlock--token-variable"> perl -pe </span><span class="CodeBlock--token-variable CodeBlock--token-string">'s/</span><span class="CodeBlock--token-variable CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-variable CodeBlock--token-string">/</span><span class="CodeBlock--token-variable CodeBlock--token-string CodeBlock--token-entity">\\</span><span class="CodeBlock--token-variable CodeBlock--token-string">n/g'</span><span class="CodeBlock--token-variable">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-assign-left CodeBlock--token-variable">request_body</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-variable">$(</span><span class="CodeBlock--token-variable CodeBlock--token-operator">&lt;</span><span class="CodeBlock--token-variable"> </span><span class="CodeBlock--token-variable CodeBlock--token-operator">&lt;</span><span class="CodeBlock--token-variable CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-variable CodeBlock--token-function">cat</span><span class="CodeBlock--token-variable"> </span><span class="CodeBlock--token-variable CodeBlock--token-operator">&lt;&lt;</span><span class="CodeBlock--token-variable CodeBlock--token-string">EOF</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">{</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">  "validity_days": 3650,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">  "csr":"</span><span class="CodeBlock--token-variable CodeBlock--token-string CodeBlock--token-variable">$CSR</span><span class="CodeBlock--token-variable CodeBlock--token-string">"</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">}</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">EOF</span><span class="CodeBlock--token-variable"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable"></span><span class="CodeBlock--token-variable CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-variable">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">// save the response so we can view it and </span><span class="CodeBlock--token-keyword">then</span><span class="CodeBlock--token-plain"> extra the certificate</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">curl</span><span class="CodeBlock--token-plain"> -H </span><span class="CodeBlock--token-string">'X-Auth-Email: YOUR_EMAIL'</span><span class="CodeBlock--token-plain"> -H </span><span class="CodeBlock--token-string">'X-Auth-Key: YOUR_API_KEY'</span><span class="CodeBlock--token-plain"> -H </span><span class="CodeBlock--token-string">'Content-Type: application/json'</span><span class="CodeBlock--token-plain"> -d “</span><span class="CodeBlock--token-variable">$request_body</span><span class="CodeBlock--token-plain">” https://api.cloudflare.com/client/v4/zones/YOUR_ZONE_ID/client_certificates </span><span class="CodeBlock--token-operator">&gt;</span><span class="CodeBlock--token-plain"> response.json</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">cat</span><span class="CodeBlock--token-plain"> response.json </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> jq </span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">.</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-string">"success"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> true,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-string">"errors"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-string">"messages"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-string">"result"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"id"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"7bf7f70c-7600-42e1-81c4-e4c0da9aa515"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"certificate_authority"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">"id"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"8f5606d9-5133-4e53-b062-a2e5da51be5e"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">"name"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Cloudflare Managed CA for account 11cbe197c050c9e422aaa103cfe30ed8"</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"certificate"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"-----BEGIN CERTIFICATE-----</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string">MIIEkzCCA...</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string">-----END CERTIFICATE-----</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string">"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"csr"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"-----BEGIN CERTIFICATE REQUEST-----</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string">MIIDITCCA...</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string">-----END CERTIFICATE REQUEST-----</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string">"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"ski"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"eb2a48a19802a705c0e8a39489a71bd586638fdf"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"serial_number"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"133270673305904147240315902291726509220894288063"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"signature"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"SHA256WithRSA"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"common_name"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"ios-bootstrap.devices.upinatoms.com"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"organization"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Temperature Testers, Inc."</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"organizational_unit"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Tech Operations"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"country"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"US"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"state"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Texas"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"location"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"Austin"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"expires_on"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"2030-09-26T02:41:00Z"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"issued_on"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"2020-09-28T02:41:00Z"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"fingerprint_sha256"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"84b045d498f53a59bef53358441a3957de81261211fc9b6d46b0bf5880bdaf25"</span><span class="CodeBlock--token-plain">,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-string">"validity_days"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">3650</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">cat</span><span class="CodeBlock--token-plain"> response.json </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> jq .result.certificate </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> perl -npe </span><span class="CodeBlock--token-string">'s/</span><span class="CodeBlock--token-string CodeBlock--token-entity">\\</span><span class="CodeBlock--token-string">n/</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string">/g; s/"//g'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">&gt;</span><span class="CodeBlock--token-plain"> ios.pem</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-comment"># Now ask that the second client certificate signing request be signed.</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-assign-left CodeBlock--token-variable">CSR</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-variable">$(</span><span class="CodeBlock--token-variable CodeBlock--token-function">cat</span><span class="CodeBlock--token-variable"> sensor.csr </span><span class="CodeBlock--token-variable CodeBlock--token-operator">|</span><span class="CodeBlock--token-variable"> perl -pe </span><span class="CodeBlock--token-variable CodeBlock--token-string">'s/</span><span class="CodeBlock--token-variable CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-variable CodeBlock--token-string">/</span><span class="CodeBlock--token-variable CodeBlock--token-string CodeBlock--token-entity">\\</span><span class="CodeBlock--token-variable CodeBlock--token-string">n/g'</span><span class="CodeBlock--token-variable">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-assign-left CodeBlock--token-variable">request_body</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-variable">$(</span><span class="CodeBlock--token-variable CodeBlock--token-operator">&lt;</span><span class="CodeBlock--token-variable"> </span><span class="CodeBlock--token-variable CodeBlock--token-operator">&lt;</span><span class="CodeBlock--token-variable CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-variable CodeBlock--token-function">cat</span><span class="CodeBlock--token-variable"> </span><span class="CodeBlock--token-variable CodeBlock--token-operator">&lt;&lt;</span><span class="CodeBlock--token-variable CodeBlock--token-string">EOF</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">{</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">  "validity_days": 3650,</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">  "csr":"</span><span class="CodeBlock--token-variable CodeBlock--token-string CodeBlock--token-variable">$CSR</span><span class="CodeBlock--token-variable CodeBlock--token-string">"</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">}</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable CodeBlock--token-string">EOF</span><span class="CodeBlock--token-variable"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-variable"></span><span class="CodeBlock--token-variable CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-variable">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">$ </span><span class="CodeBlock--token-function">curl</span><span class="CodeBlock--token-plain"> -H </span><span class="CodeBlock--token-string">'X-Auth-Email: YOUR_EMAIL'</span><span class="CodeBlock--token-plain"> -H </span><span class="CodeBlock--token-string">'X-Auth-Key: YOUR_API_KEY'</span><span class="CodeBlock--token-plain"> -H </span><span class="CodeBlock--token-string">'Content-Type: application/json'</span><span class="CodeBlock--token-plain"> -d </span><span class="CodeBlock--token-string">"</span><span class="CodeBlock--token-string CodeBlock--token-variable">$request_body</span><span class="CodeBlock--token-string">"</span><span class="CodeBlock--token-plain"> https://api.cloudflare.com/client/v4/zones/YOUR_ZONE_ID/client_certificates </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> perl -npe </span><span class="CodeBlock--token-string">'s/</span><span class="CodeBlock--token-string CodeBlock--token-entity">\\</span><span class="CodeBlock--token-string">n/</span><span class="CodeBlock--token-string CodeBlock--token-entity">\n</span><span class="CodeBlock--token-string">/g; s/"//g'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">&gt;</span><span class="CodeBlock--token-plain"> sensor.pem</span></span></span></span></span></code></pre><hr><h2 id="embed-the-client-certificate-in-your-mobile-app"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#embed-the-client-certificate-in-your-mobile-app" aria-hidden="true">​</a></span><span>Embed the client certificate in your mobile app</span></h2><p>To configure the mobile app to securely request temperature data submitted by the IoT device, embed the client certificate in the mobile app.</p><p>For simplicity, this example embeds a “bootstrap” certificate and key in the application bundle as a PKCS#12-formatted file:</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-sh" language="sh"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-command CodeBlock--token-prompt CodeBlock--token-unselectable">$ </span><span class="CodeBlock--token-command">openssl pkcs12 -export -out bootstrap-cert.pfx -inkey ios-key.pem -in ios.pem</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">Enter Export Password:</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">Verifying - Enter Export Password:</span></span></span></span></span></code></pre><p>In a real-world deployment, a bootstrap certificate should only be used in conjunction with users’ credentials to authenticate with an API endpoint that can return a unique user certificate. Corporate users will want to use mobile device management (MDM) to distribute certificates.</p><h3 id="embed-the-client-certificate-in-an-android-app"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#embed-the-client-certificate-in-an-android-app" aria-hidden="true">​</a></span><span>Embed the client certificate in an Android app</span></h3><p>The following is an example of how you may use a client certificate in an Android app to make HTTP calls. You need to add the following permission in <code class="InlineCode">AndroidManifest.xml</code> to allow an Internet connection.</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-xml" language="xml"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-tag CodeBlock--token-punctuation">&lt;</span><span class="CodeBlock--token-tag">uses-permission</span><span class="CodeBlock--token-tag"> </span><span class="CodeBlock--token-tag CodeBlock--token-attr-name CodeBlock--token-namespace">android:</span><span class="CodeBlock--token-tag CodeBlock--token-attr-name">name</span><span class="CodeBlock--token-tag CodeBlock--token-attr-value CodeBlock--token-punctuation">=</span><span class="CodeBlock--token-tag CodeBlock--token-attr-value CodeBlock--token-punctuation">"</span><span class="CodeBlock--token-tag CodeBlock--token-attr-value">android.permission.INTERNET</span><span class="CodeBlock--token-tag CodeBlock--token-attr-value CodeBlock--token-punctuation">"</span><span class="CodeBlock--token-tag"> </span><span class="CodeBlock--token-tag CodeBlock--token-punctuation">/&gt;</span></span></span></span></span></code></pre><p>For demonstration purposes, the certificate in this example is stored in <code class="InlineCode">app/src/main/res/raw/cert.pem</code> and the private key is stored in <code class="InlineCode">app/src/main/res/raw/key.pem</code>. You may also store these files in other secure manners. </p><p>The following example uses an <code class="InlineCode">OkHttpClient</code>, but you may also use other clients such as <code class="InlineCode">HttpURLConnection</code> in similar ways. The key is to use the <code class="InlineCode">SSLSocketFactory</code>.</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-java" language="java"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">private</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">OkHttpClient</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">setUpClient</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">try</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">final</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">String</span><span class="CodeBlock--token-plain"> SECRET </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"secret"</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-comment">// You may also store this String somewhere more secure.</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">CertificateFactory</span><span class="CodeBlock--token-plain"> certificateFactory </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">CertificateFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getInstance</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"X.509"</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-comment">// Get private key</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">InputStream</span><span class="CodeBlock--token-plain"> privateKeyInputStream </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">getResources</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">openRawResource</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-class-name">R</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">raw</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">key</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">byte</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> privateKeyByteArray </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">byte</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain">privateKeyInputStream</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">available</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        privateKeyInputStream</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">read</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">privateKeyByteArray</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">String</span><span class="CodeBlock--token-plain"> privateKeyContent </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">String</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">privateKeyByteArray</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">Charset</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">defaultCharset</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">                </span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">replace</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"-----BEGIN PRIVATE KEY-----"</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">""</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">                </span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">replaceAll</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-class-name">System</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">lineSeparator</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">""</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">                </span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">replace</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"-----END PRIVATE KEY-----"</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">""</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">byte</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> rawPrivateKeyByteArray </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">Base64</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getDecoder</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">decode</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">privateKeyContent</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">KeyFactory</span><span class="CodeBlock--token-plain"> keyFactory </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">KeyFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getInstance</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"RSA"</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">PKCS8EncodedKeySpec</span><span class="CodeBlock--token-plain"> keySpec </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">PKCS8EncodedKeySpec</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">rawPrivateKeyByteArray</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-comment">// Get certificate</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">InputStream</span><span class="CodeBlock--token-plain"> certificateInputStream </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">getResources</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">openRawResource</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-class-name">R</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">raw</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">cert</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">Certificate</span><span class="CodeBlock--token-plain"> certificate </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> certificateFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">generateCertificate</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">certificateInputStream</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-comment">// Set up KeyStore</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">KeyStore</span><span class="CodeBlock--token-plain"> keyStore </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">KeyStore</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getInstance</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-class-name">KeyStore</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getDefaultType</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        keyStore</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">load</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-keyword">null</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> SECRET</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">toCharArray</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        keyStore</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">setKeyEntry</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"client"</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> keyFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">generatePrivate</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">keySpec</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> SECRET</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">toCharArray</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">Certificate</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain">certificate</span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        certificateInputStream</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">close</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-comment">// Set up Trust Managers</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">TrustManagerFactory</span><span class="CodeBlock--token-plain"> trustManagerFactory </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">TrustManagerFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getInstance</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-class-name">TrustManagerFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getDefaultAlgorithm</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        trustManagerFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">init</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-class-name">KeyStore</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">null</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">TrustManager</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> trustManagers </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> trustManagerFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getTrustManagers</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-comment">// Set up Key Managers</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">KeyManagerFactory</span><span class="CodeBlock--token-plain"> keyManagerFactory </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">KeyManagerFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getInstance</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-class-name">KeyManagerFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getDefaultAlgorithm</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        keyManagerFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">init</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">keyStore</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> SECRET</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">toCharArray</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">KeyManager</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"> keyManagers </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> keyManagerFactory</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getKeyManagers</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-comment">// Obtain SSL Socket Factory</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">SSLContext</span><span class="CodeBlock--token-plain"> sslContext </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">SSLContext</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getInstance</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"TLS"</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        sslContext</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">init</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">keyManagers</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> trustManagers</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">SecureRandom</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">SSLSocketFactory</span><span class="CodeBlock--token-plain"> sslSocketFactory </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> sslContext</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">getSocketFactory</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-comment">// Finally, return the client, which will then be used to make HTTP calls.</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-class-name">OkHttpClient</span><span class="CodeBlock--token-plain"> client </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">new</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">OkHttpClient</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-class-name">Builder</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">                </span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">sslSocketFactory</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">sslSocketFactory</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">                </span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">build</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> client</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">catch</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-class-name">CertificateException</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">IOException</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">NoSuchAlgorithmException</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">KeyStoreException</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">UnrecoverableKeyException</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">KeyManagementException</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">|</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-class-name">InvalidKeySpecException</span><span class="CodeBlock--token-plain"> e</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        e</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-function">printStackTrace</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">null</span><span class="CodeBlock--token-punctuation">;</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-punctuation">}</span></span></span></span></span></code></pre><p>The above function returns an <code class="InlineCode">OkHttpClient</code> embedded with the client certificate. You can now use this client to make HTTP requests to your API endpoint protected with mTLS.</p><hr><h2 id="embed-the-client-certificate-on-your-iot-device"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#embed-the-client-certificate-on-your-iot-device" aria-hidden="true">​</a></span><span>Embed the client certificate on your IoT device</span></h2><p>To prepare the IoT device for secure communication with the API endpoint, embed the certificate on the device and configure the device to use the certificate when making POST requests.</p><p>This example assumes the certificate and the private key are securely copied to <code class="InlineCode">/etc/ssl/private/sensor-key.pem</code> and <code class="InlineCode">/etc/ssl/certs/sensor.pem</code>.</p><p>The sample script is modified to point to these files:</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-python" language="python"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> requests</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> json</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">from</span><span class="CodeBlock--token-plain"> datetime </span><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> datetime</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">def</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">readSensor</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># Takes a reading from a temperature sensor and store it to temp_measurement</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    dateTimeObj </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> datetime</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">now</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    timestampStr </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> dateTimeObj</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">strftime</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">‘</span><span class="CodeBlock--token-operator">%</span><span class="CodeBlock--token-plain">Y</span><span class="CodeBlock--token-operator">-</span><span class="CodeBlock--token-operator">%</span><span class="CodeBlock--token-plain">m</span><span class="CodeBlock--token-operator">-</span><span class="CodeBlock--token-operator">%</span><span class="CodeBlock--token-plain">dT</span><span class="CodeBlock--token-operator">%</span><span class="CodeBlock--token-plain">H</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-operator">%</span><span class="CodeBlock--token-plain">M</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-operator">%</span><span class="CodeBlock--token-plain">SZ’</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    measurement </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string">'temperature'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-builtin">str</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">temp_measurement</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-string">'time'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain">timestampStr</span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> measurement</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">def</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">main</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"Cloudflare API Shield [IoT device demonstration]"</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    temperature </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> readSensor</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    payload </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> json</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">dumps</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">temperature</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    url </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'https://shield.upinatoms.com/temps'</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    json_headers </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string">'Content-Type'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'application/json'</span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    cert_file </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'/etc/ssl/certs/sensor.pem'</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'/etc/ssl/private/sensor-key.pem'</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    r </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> requests</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">post</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">url</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> headers </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> json_headers</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> data </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> payload</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> cert </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> cert_file</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"Request body: "</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> r</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">request</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">body</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">"Response status code: %d"</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">%</span><span class="CodeBlock--token-plain"> r</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">status_code</span><span class="CodeBlock--token-punctuation">)</span></span></span></span></span></code></pre><p>When the script attempts to connect to <code class="InlineCode">https://shield.upinatoms.com/temps</code>, Cloudflare requests that a client certificate is sent, and the script sends the contents of <code class="InlineCode">/etc/ssl/certs/sensor.pem</code> and then, as required to complete the SSL/TLS handshake, demonstrates it has possession of <code class="InlineCode">/etc/ssl/private/sensor-key.pem</code>.</p><p>Without the client certificate, the Cloudflare rejects the request:</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-bash" language="bash"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">Cloudflare API Shield </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain">IoT device demonstration</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">Request body:  </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string">"temperature"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"36.5"</span><span class="CodeBlock--token-plain">, </span><span class="CodeBlock--token-string">"time"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"2020-09-28T15:52:19Z"</span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">Response status code: </span><span class="CodeBlock--token-number">403</span></span></span></span></span></code></pre><p>When the IoT device presents a valid client certificate, the POST request succeeds and the temperature reading is recorded:</p><pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-bash" language="bash"><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">Cloudflare API Shield </span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-plain">IoT device demonstration</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">Request body:  </span><span class="CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string">"temperature"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"36.5"</span><span class="CodeBlock--token-plain">, </span><span class="CodeBlock--token-string">"time"</span><span class="CodeBlock--token-builtin CodeBlock--token-class-name">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">"2020-09-28T15:56:45Z"</span><span class="CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-plain"></span></span></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><span class="CodeBlock--row-content"><span class="CodeBlock--token-plain">Response status code: </span><span class="CodeBlock--token-number">201</span></span></span></span></span></code></pre><hr><h2 id="enable-mtls"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#enable-mtls" aria-hidden="true">​</a></span><span>Enable mTLS</span></h2><p>After creating Cloudflare-issued certificates, the next step is to enable mTLS for the hosts you want to protect with API Shield.</p><p>For instructions, see <a class="DocsMarkdown--link" href="/ssl/client-certificates/enable-mtls"><span class="DocsMarkdown--link-content"><em>Enable mutual Transport Layer Security</em></span></a>.</p><hr><h2 id="configure-api-shield-to-require-client-certificates"><span class="DocsMarkdown--header-anchor-positioner"><a class="DocsMarkdown--header-anchor Link Link-without-underline" href="#configure-api-shield-to-require-client-certificates" aria-hidden="true">​</a></span><span>Configure API Shield to require client certificates</span></h2><p>To configure API Shield to require client certificates, <a href="https://developers.cloudflare.com/firewall/cf-dashboard/create-mtls-rule" class="DocsMarkdown--link"><span class="DocsMarkdown--link-content">create a mTLS rule</span><span class="DocsMarkdown--link-external-icon" aria-hidden="true"><svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 16 16" role="img" aria-labelledby="title-24349066235964978" xmlns="http://www.w3.org/2000/svg"><title id="title-24349066235964978">External link icon</title><path d="M6.75,1.75h-5v12.5h12.5v-5m0,-4v-3.5h-3.5M8,8l5.5-5.5"></path></svg><span is-visually-hidden="">Open external link</span></span></a>.</p>"));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"demo":null,"difficulty":null,"summary":null,"tags":null,"title":"","type":null,"updated":null}}},"pageContext":{"id":"5723ab69-1dc0-50b8-b36d-ada4a59cc8da","fields":{"slug":"/client-certificates/configure-your-mobile-app-or-iot-device"},"frontmatter":{"title":"","type":null,"order":3,"hidden":null,"hideChildren":null,"breadcrumbs":null},"headings":[{"value":"Configure your mobile app or IoT device","depth":1}],"tableOfContents":{"items":[{"url":"#configure-your-mobile-app-or-iot-device","title":"Configure your mobile app or IoT device","items":[{"url":"#validate-api","title":"Validate API","items":[{"url":"#post-sample-data-to-api","title":"POST sample data to API"},{"url":"#get-sample-data-from-api","title":"GET sample data from API"}]},{"url":"#create-cloudflare-issued-certificates","title":"Create Cloudflare-issued certificates"},{"url":"#embed-the-client-certificate-in-your-mobile-app","title":"Embed the client certificate in your mobile app","items":[{"url":"#embed-the-client-certificate-in-an-android-app","title":"Embed the client certificate in an Android app"}]},{"url":"#embed-the-client-certificate-on-your-iot-device","title":"Embed the client certificate on your IoT device"},{"url":"#enable-mtls","title":"Enable mTLS"},{"url":"#configure-api-shield-to-require-client-certificates","title":"Configure API Shield to require client certificates"}]}]},"parent":{"modifiedTime":"2021-07-26","relativePath":"client-certificates/configure-your-mobile-app-or-iot-device.md"}}},"staticQueryHashes":["9999"]}